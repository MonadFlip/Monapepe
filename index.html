<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StakeTokenETH DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { padding: 8px; margin: 5px; }
    .section { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>StakeTokenETH DApp</h1>
  <button id="connectWallet">Connect Wallet</button>
  <div id="walletAddress"></div>

  <div class="section">
    <h2>Contract Info</h2>
    <button id="refreshData">Refresh Data</button>
    <p>Token Balance: <span id="tokenBalance">0</span></p>
    <p>Staked Amount: <span id="stakedAmount">0</span></p>
    <p>Pending Reward: <span id="pendingReward">0</span></p>
    <p>Contract Balance: <span id="contractBalance">0</span></p>
  </div>

  <div class="section">
    <h2>Actions</h2>

    <div>
      <h3>Stake Token</h3>
      <input type="number" id="stakeAmount" placeholder="Amount to stake">
      <button id="maxStake">Max</button>
      <button id="stakeButton">Stake</button>
    </div>

    <div>
      <h3>Unstake Token</h3>
      <input type="number" id="unstakeAmount" placeholder="Amount to unstake">
      <button id="maxUnstake">Max</button>
      <button id="unstakeButton">Unstake</button>
    </div>

    <div>
      <h3>Claim Reward</h3>
      <button id="claimRewardButton">Claim Reward</button>
    </div>

    <div>
      <h3>Emergency Withdraw</h3>
      <button id="emergencyWithdrawButton">Emergency Withdraw</button>
    </div>
  </div>

  <script>
    let provider, signer, contract, tokenContract, userAddress;

    // Contract Addresses
    const tokenAddress = "0xB31be452692c5d7e2C1c3eD3FbD769a2723e3BEA";
    const stakingAddress = "0x9a6F85f4090292eE248B2C999a3E1422B1297177";

    // ABI Definitions
    const stakingABI = [
      "function stake(uint256 amount) external",
      "function unstake(uint256 amount) external",
      "function claimReward() external",
      "function emergencyWithdraw() external",
      "function pendingReward(address user) external view returns (uint256)",
      "function getStakedAmount(address user) external view returns (uint256)",
      "function contractBalance() external view returns (uint256)"
    ];

    const tokenABI = [
      "function balanceOf(address owner) external view returns (uint256)",
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)"
    ];

    async function checkNetwork() {
      if (!window.ethereum) return;
      const chainId = await window.ethereum.request({ method: "eth_chainId" });
      if (chainId !== "0x279f") { // 0x279f == 10143 in hex
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0x279f" }],
          });
          console.log("Switched to Monad Testnet");
        } catch (switchError) {
          if (switchError.code === 4902) {
            try {
              await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [{
                  chainId: "0x279f",
                  chainName: "Monad Testnet",
                  nativeCurrency: { name: "MON", symbol: "MON", decimals: 18 },
                  rpcUrls: ["https://10143.rpc.thirdweb.com"],
                }],
              });
              console.log("Monad Testnet added and switched");
            } catch (addError) {
              console.error("Error adding network: ", addError);
              alert("Please add the Monad Testnet network manually using the provided RPC.");
            }
          } else {
            console.error("Error switching network: ", switchError);
            alert("Please switch to the Monad Testnet network.");
          }
        }
      }
    }

    async function connectWallet() {
      if (window.ethereum) {
        try {
          await checkNetwork();
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          // Disable ENS lookups on networks that do not support ENS:
          provider.ens = null;
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          document.getElementById("walletAddress").innerText = "Connected: " + userAddress;
          contract = new ethers.Contract(stakingAddress, stakingABI, signer);
          tokenContract = new ethers.Contract(tokenAddress, tokenABI, signer);
          refreshData();
        } catch (error) {
          console.error(error);
          alert("Wallet connection failed.");
        }
      } else {
        alert("Please install MetaMask.");
      }
    }

    async function refreshData() {
      if (!contract || !tokenContract || !userAddress) return;
      try {
        const tokenBalance = await tokenContract.balanceOf(userAddress);
        const stakedAmount = await contract.getStakedAmount(userAddress);
        const pendingReward = await contract.pendingReward(userAddress);
        const contractBal = await contract.contractBalance();

        document.getElementById("tokenBalance").innerText = ethers.utils.formatEther(tokenBalance);
        document.getElementById("stakedAmount").innerText = ethers.utils.formatEther(stakedAmount);
        document.getElementById("pendingReward").innerText = ethers.utils.formatEther(pendingReward);
        document.getElementById("contractBalance").innerText = ethers.utils.formatEther(contractBal);
      } catch (error) {
        console.error(error);
        alert("Error fetching contract data.");
      }
    }

    async function stakeTokens() {
      const amount = document.getElementById("stakeAmount").value;
      if (!amount || isNaN(amount)) return alert("Enter a valid amount.");

      const parsedAmount = ethers.utils.parseEther(amount);
      const allowance = await tokenContract.allowance(userAddress, stakingAddress);

      if (allowance.lt(parsedAmount)) {
        const approveTx = await tokenContract.approve(stakingAddress, parsedAmount);
        await approveTx.wait();
      }

      const tx = await contract.stake(parsedAmount);
      await tx.wait();
      alert("Stake successful.");
      refreshData();
    }

    async function unstakeTokens() {
      const amount = document.getElementById("unstakeAmount").value;
      if (!amount || isNaN(amount)) return alert("Enter a valid amount.");

      const tx = await contract.unstake(ethers.utils.parseEther(amount));
      await tx.wait();
      alert("Unstake successful.");
      refreshData();
    }

    async function maxStake() {
      const balance = await tokenContract.balanceOf(userAddress);
      document.getElementById("stakeAmount").value = ethers.utils.formatEther(balance);
    }

    async function maxUnstake() {
      const staked = await contract.getStakedAmount(userAddress);
      document.getElementById("unstakeAmount").value = ethers.utils.formatEther(staked);
    }

    async function claimReward() {
      try {
        const tx = await contract.claimReward();
        await tx.wait();
        alert("Reward claimed successfully.");
        refreshData();
      } catch (error) {
        console.error(error);
        alert("Error claiming reward.");
      }
    }

    async function emergencyWithdraw() {
      try {
        const tx = await contract.emergencyWithdraw();
        await tx.wait();
        alert("Emergency withdraw successful.");
        refreshData();
      } catch (error) {
        console.error(error);
        alert("Error during emergency withdraw.");
      }
    }

    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    document.getElementById("refreshData").addEventListener("click", refreshData);
    document.getElementById("stakeButton").addEventListener("click", stakeTokens);
    document.getElementById("unstakeButton").addEventListener("click", unstakeTokens);
    document.getElementById("maxStake").addEventListener("click", maxStake);
    document.getElementById("maxUnstake").addEventListener("click", maxUnstake);
    document.getElementById("claimRewardButton").addEventListener("click", claimReward);
    document.getElementById("emergencyWithdrawButton").addEventListener("click", emergencyWithdraw);
  </script>
</body>
</html>
