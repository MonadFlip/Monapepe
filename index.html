<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>APR Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 8px; }
  </style>
</head>
<body>
  <h1>APR Calculator</h1>
  <button id="connectWallet">Connect Wallet</button>
  <div id="walletAddress"></div>
  <br>
  <button id="calculateAPR">Calculate APR</button>
  <div style="margin-top: 20px;">
    <p>Price of Monapepe (in wETH): <span id="price"></span></p>
    <p>Total Staked Value (in MON): <span id="totalValue"></span></p>
    <p>APR: <span id="apr"></span>%</p>
  </div>

  <script>
    let provider, signer, userAddress;
    
    // Addresses
    const poolAddress    = "0x4a0A2B293A34c54d0965D23f8131A3D2c0b91290";
    const wETHAddress    = "0x3bb9AFB94c82752E47706A10779EA525Cf95dc27";
    const monapepeAddress= "0xB31be452692c5d7e2C1c3eD3FbD769a2723e3BEA";
    const stakingAddress = "0x9a6F85f4090292eE248B2C999a3E1422B1297177";

    // Minimal ABI for Uniswap V2 Pool
    const poolABI = [
      "function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
      "function token0() external view returns (address)",
      "function token1() external view returns (address)"
    ];
    
    // Minimal ABI for Staking Contract (totalStaked is a public variable)
    const stakingABI = [
      "function totalStaked() external view returns (uint256)"
    ];

    // Connect to MetaMask wallet
    async function connectWallet() {
      if (!window.ethereum) {
        alert("Please install MetaMask.");
        return;
      }
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        // Disable ENS lookup on networks without ENS support
        provider.ens = null;
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("walletAddress").innerText = "Connected: " + userAddress;
      } catch (error) {
        console.error(error);
        alert("Wallet connection failed.");
      }
    }

    // Calculate APR based on on-chain data
    async function calculateAPR() {
      if (!provider) {
        alert("Please connect your wallet first.");
        return;
      }
      try {
        // Instantiate Uniswap pool contract and fetch reserves and token order
        const poolContract = new ethers.Contract(poolAddress, poolABI, provider);
        const reserves = await poolContract.getReserves();
        const token0 = await poolContract.token0();
        const token1 = await poolContract.token1();
        
        let reserveWETH, reserveMonapepe;
        // Determine which reserve is which based on token addresses
        if (token0.toLowerCase() === wETHAddress.toLowerCase() && token1.toLowerCase() === monapepeAddress.toLowerCase()) {
          reserveWETH     = reserves.reserve0;
          reserveMonapepe = reserves.reserve1;
        } else if (token0.toLowerCase() === monapepeAddress.toLowerCase() && token1.toLowerCase() === wETHAddress.toLowerCase()) {
          reserveWETH     = reserves.reserve1;
          reserveMonapepe = reserves.reserve0;
        } else {
          alert("Pool does not contain the expected tokens.");
          return;
        }
        
        // Convert reserves from BigNumber to a float (assuming 18 decimals)
        const rWETH     = parseFloat(ethers.utils.formatEther(reserveWETH));
        const rMonapepe = parseFloat(ethers.utils.formatEther(reserveMonapepe));
        
        // Price of one Monapepe in wETH: Price = R_weth / R_monapepe
        const price = rWETH / rMonapepe;
        document.getElementById("price").innerText = price.toFixed(6);
        
        // Instantiate the staking contract and fetch total staked Monapepe
        const stakingContract = new ethers.Contract(stakingAddress, stakingABI, provider);
        const totalStakedBN = await stakingContract.totalStaked();
        const stakedMonapepe = parseFloat(ethers.utils.formatEther(totalStakedBN));
        
        // Total staked value in MON is calculated as:
        // Total_Value = stakedMonapepe * Price
        // (Assuming 1 MON is equivalent to 1 wETH)
        const totalValue = stakedMonapepe * price;
        document.getElementById("totalValue").innerText = totalValue.toFixed(6);
        
        // Annual reward is 8765 MON.
        const annualReward = 8765;
        // APR = (Annual Reward / Total Staked Value) * 100%
        let apr = 0;
        if (totalValue > 0) {
          apr = (annualReward / totalValue) * 100;
        }
        document.getElementById("apr").innerText = apr.toFixed(2);
      } catch (error) {
        console.error(error);
        alert("Error calculating APR. See console for details.");
      }
    }
    
    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    document.getElementById("calculateAPR").addEventListener("click", calculateAPR);
  </script>
</body>
</html>
